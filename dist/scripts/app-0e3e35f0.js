"use strict";// MIT License   - www.webrtc-experiment.com/licence
// Documentation - github.com/streamproc/MediaStreamRecorder
function MediaStreamRecorder(t){if(!t)throw"MediaStream is mandatory.";this.start=function(a){var n=IsChrome?window.StereoRecorder:window.MediaRecorderWrapper;-1!=this.mimeType.indexOf("video")&&(n=IsChrome?window.WhammyRecorder:window.MediaRecorderWrapper),"image/gif"===this.mimeType&&(n=window.GifRecorder),e=new n(t,this.type),e.ondataavailable=this.ondataavailable,e.onstop=this.onstop,e=mergeProps(e,this),e.start(a)},this.stop=function(){e&&e.stop()},this.ondataavailable=function(t){console.log("ondataavailable..",t)},this.onstop=function(t){console.warn("stopped..",t)};var e}function loadScript(t,e){var a=window.MediaStreamRecorderScriptsDir,n=document.createElement("script");n.src=a+t,n.onload=e||function(){},document.documentElement.appendChild(n)}function mergeProps(t,e){e=reformatProps(e);for(var a in e)"function"!=typeof e[a]&&(t[a]=e[a]);return t}function reformatProps(t){var e={};for(var a in t)if(-1!=a.indexOf("-")){var n=a.split("-"),i=n[0]+n[1].split("")[0].toUpperCase()+n[1].substr(1);e[i]=t[a]}else e[a]=t[a];return e}function dropFirstFrame(t){return t.shift(),t}function MediaRecorderWrapper(t,e){if("audio"===e&&t.getVideoTracks&&t.getVideoTracks().length&&!navigator.mozGetUserMedia){var a=new AudioContext,n=a.createMediaStreamSource(t),i=a.createMediaStreamDestination();n.connect(i),t=i.stream}this.start=function(e){function a(){r||(d=new MediaRecorder(t),d.ondataavailable=function(t){if(console.log("ondataavailable",t.data.type,t.data.size,t.data),!t.data.size)return void console.warn("Recording of",t.data.type,"failed.");var e=new window.Blob([t.data],{type:t.data.type||o.mimeType||"audio/ogg"});o.ondataavailable(e)},d.onstop=function(){},d.onerror=function(t){console.error(t),o.start(e)},d.onwarning=function(t){console.warn(t)},d.start(0),setTimeout(function(){d.stop(),a()},e))}e=e||1e3,r=!1,a()};var r=!1;this.stop=function(){r=!0,o.onstop&&o.onstop({})},this.ondataavailable=this.onstop=function(){};var o=this;!o.mimeType&&t.getAudioTracks&&(o.mimeType=t.getAudioTracks().length&&t.getVideoTracks().length?"video/webm":"audio/ogg");var d}function StereoRecorder(t){this.start=function(n){n=n||1e3,e=new StereoAudioRecorder(t,this),e.record(),a=setInterval(function(){e.requestData()},n)},this.stop=function(){e&&(e.stop(),clearTimeout(a))},this.ondataavailable=function(){};var e,a}function StereoAudioRecorder(t,e){function a(t,e){if(e==p)return t;if(e>p)throw"downsampling rate show be smaller than original sample rate";for(var a=p/e,n=Math.round(t.length/a),i=new Float32Array(n),r=0,o=0;r<i.length;){for(var d=Math.round((r+1)*a),s=0,u=0,c=o;d>c&&c<t.length;c++)s+=t[c],u++;i[r]=s/u,r++,o=d}return i}function n(t,e){for(var a=t.length+e.length,n=new Float32Array(a),i=0,r=0;a>r;)n[r++]=t[i],n[r++]=e[i],i++;return n}function i(t,e){for(var a=new Float32Array(e),n=0,i=t.length,r=0;i>r;r++){var o=t[r];a.set(o,n),n+=o.length}return a}function r(t,e,a){for(var n=a.length,i=0;n>i;i++)t.setUint8(e+i,a.charCodeAt(i))}var o,d,s,u,c,h=[],l=[],m=!1,f=0,p=44100,w=4800;this.record=function(){m=!0,h.length=l.length=0,f=0},this.requestData=function(){if(0==f)return void(v=!1);v=!0;var t=h.slice(0),o=(l.slice(0),f);h.length=l.length=[],f=0,v=!1;var d=i(t,o),s=i(t,o),u=n(d,s),u=a(u,w),c=new ArrayBuffer(44+2*u.length),m=new DataView(c);r(m,0,"RIFF"),m.setUint32(4,44+2*u.length,!0),r(m,8,"WAVE"),r(m,12,"fmt "),m.setUint32(16,16,!0),m.setUint16(20,1,!0),m.setUint16(22,2,!0),m.setUint32(24,w,!0),m.setUint32(28,4*w,!0),m.setUint16(32,4,!0),m.setUint16(34,16,!0),r(m,36,"data"),m.setUint32(40,2*u.length,!0);for(var p=u.length,g=44,b=1,y=0;p>y;y++)m.setInt16(g,32767*u[y]*b,!0),g+=2;var A=new Blob([m],{type:"audio/wav"});e.ondataavailable(A)},this.stop=function(){m=!1,this.requestData()};var u=ObjectStore.AudioContext;ObjectStore.AudioContextConstructor||(ObjectStore.AudioContextConstructor=new u);var c=ObjectStore.AudioContextConstructor;ObjectStore.VolumeGainNode||(ObjectStore.VolumeGainNode=c.createGain());var d=ObjectStore.VolumeGainNode;ObjectStore.AudioInput||(ObjectStore.AudioInput=c.createMediaStreamSource(t));var s=ObjectStore.AudioInput;s.connect(d);var g=2048;if(c.createJavaScriptNode)o=c.createJavaScriptNode(g,2,2);else{if(!c.createScriptProcessor)throw"WebAudio API has no support on this browser.";o=c.createScriptProcessor(g,2,2)}var v=!1;window.scriptprocessornode=o,o.onaudioprocess=function(t){if(m&&!v){var e=t.inputBuffer.getChannelData(0),a=t.inputBuffer.getChannelData(1);h.push(new Float32Array(e)),l.push(new Float32Array(a)),f+=g}},d.connect(o),o.connect(c.destination)}function WhammyRecorderHelper(t,e){function a(){if(!r){if(n)return setTimeout(a,100);var t=(new Date).getTime()-u;if(!t)return a();u=(new Date).getTime(),d.drawImage(s,0,0,o.width,o.height),!r&&i.push({duration:t,image:o.toDataURL("image/webp")}),setTimeout(a,10)}}this.record=function(){this.width||(this.width=s.offsetWidth||320),this.height||(this.height=s.offsetHeight||240),this.video||(this.video={width:this.width,height:this.height}),this.canvas||(this.canvas={width:this.width,height:this.height}),o.width=this.canvas.width,o.height=this.canvas.height,s.width=this.video.width,s.height=this.video.height,a()};var n=!1;this.requestData=function(){if(!i.length)return void(n=!1);n=!0;var t=i.slice(0);i=[],c.frames=dropFirstFrame(t);var a=c.compile();e.ondataavailable(a),n=!1};var i=[],r=!1;this.stop=function(){r=!0,this.requestData()};var o=document.createElement("canvas"),d=o.getContext("2d"),s=document.createElement("video");s.muted=!0,s.volume=0,s.autoplay=!0,s.src=URL.createObjectURL(t),s.play();var u=(new Date).getTime(),c=new Whammy.Video}function WhammyRecorder(t){this.start=function(n){n=n||1e3,e=new WhammyRecorderHelper(t,this),e.record(),a=setInterval(function(){e.requestData()},n)},this.stop=function(){e&&(e.stop(),clearTimeout(a))},this.ondataavailable=function(){};var e,a}// MIT License   - https://www.webrtc-experiment.com/licence/
// Documentation - https://github.com/streamproc/MediaStreamRecorder
// ==========================================================
// GifRecorder.js
function GifRecorder(t){function e(){d=Date.now();var t=new Blob([new Uint8Array(u.stream().bin)],{type:"image/gif"});a.ondataavailable(t),u.stream().bin=[]}if(!window.GIFEncoder)throw"Please link: https://cdn.webrtc-experiment.com/gif-recorder.js";this.start=function(t){function a(t){h=requestAnimationFrame(a),void 0===typeof s&&(s=t),90>t-s||(i.drawImage(r,0,0,d,l),u.addFrame(i),s=t)}t=t||1e3;var d=this.videoWidth||320,l=this.videoHeight||240;n.width=r.width=d,n.height=r.height=l,u=new GIFEncoder,u.setRepeat(0),u.setDelay(this.frameRate||200),u.setQuality(this.quality||1),u.start(),o=Date.now(),h=requestAnimationFrame(a),c=setTimeout(e,t)},this.stop=function(){h&&(cancelAnimationFrame(h),clearTimeout(c),e())},this.ondataavailable=function(){},this.onstop=function(){};var a=this,n=document.createElement("canvas"),i=n.getContext("2d"),r=document.createElement("video");r.muted=!0,r.autoplay=!0,r.src=URL.createObjectURL(t),r.play();var o,d,s,u,c,h=null}angular.module("webrtcTest",["ngAnimate","ngCookies","ngTouch","ngSanitize","ngRoute","ngMaterial"]).config(["$routeProvider",function(t){t.when("/",{templateUrl:"app/main/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("webrtcTest").controller("NavbarCtrl",["$scope",function(t){t.date=new Date}]),angular.module("webrtcTest").controller("MainCtrl",["$scope",function(t){function e(t){var e=1e3,a=["Bytes","KB","MB","GB","TB"];if(0===t)return"0 Bytes";var n=parseInt(Math.floor(Math.log(t)/Math.log(e)),10);return(t/Math.pow(e,n)).toPrecision(3)+" "+a[n]}function a(t){var e=new Date(t);return e.getUTCHours()+" hours, "+e.getUTCMinutes()+" minutes and "+e.getUTCSeconds()+" second(s)"}{var n={audio:!0};angular.element(document.querySelector("#audio"))}t.start=function(){navigator.getUserMedia(n,d,s)},t.stop=function(){i.stop()};var i,r=document.getElementById("audios-container"),o=1,d=function(t){angular.element(document.querySelector("#audio"));r.appendChild(document.createElement("hr")),i=new MediaStreamRecorder(t),i.mimeType="audio/ogg",i.sampleRate=4800,i.ondataavailable=function(t){var i=document.createElement("a");i.target="_blank",i.innerHTML="Open Recorded Audio No. "+o++ +" (Size: "+e(t.size)+") Time Length: "+a(n),i.href=URL.createObjectURL(t),r.appendChild(i),r.appendChild(document.createElement("hr"))};var n=5e3;n=n?parseInt(n):5e3,i.start(n)},s=function(t){console.error("media error",t)}}]),// MIT License   - www.webrtc-experiment.com/licence
// Documentation - github.com/streamproc/MediaStreamRecorder
window.requestAnimationFrame||(requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame),window.cancelAnimationFrame||(cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame),window.AudioContext||(window.AudioContext=window.webkitAudioContext||window.mozAudioContext),URL=window.URL||window.webkitURL,navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia,window.webkitMediaStream&&(window.MediaStream=window.webkitMediaStream),IsChrome=!!navigator.webkitGetUserMedia;var ObjectStore={AudioContext:window.AudioContext||window.webkitAudioContext},Whammy=function(){function t(t){for(var a=e(t),n=3e4,i=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:u(a.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:25541},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:a.width,id:176},{data:a.height,id:186}]}]}]}]}],d=0,s=0;d<t.length;){var c=[],h=0;do c.push(t[d]),h+=t[d].duration,d++;while(d<t.length&&n>h);var l=0,m={id:524531317,data:[{data:s,id:231}].concat(c.map(function(t){var e=o({discardable:0,frame:t.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(l)});return l+=t.duration,{data:e,id:163}}))};i[1].data.push(m),s+=h}return r(i)}function e(t){if(!t[0])return void console.warn("Something went wrong. Maybe WebP format is not supported in the current browser.");for(var e=t[0].width,a=t[0].height,n=t[0].duration,i=1;i<t.length;i++)n+=t[i].duration;return{duration:n,width:e,height:a}}function a(t){for(var e=[];t>0;)e.push(255&t),t>>=8;return new Uint8Array(e.reverse())}function n(t){return new Uint8Array(t.split("").map(function(t){return t.charCodeAt(0)}))}function i(t){var e=[],a=t.length%8?new Array(9-t.length%8).join("0"):"";t=a+t;for(var n=0;n<t.length;n+=8)e.push(parseInt(t.substr(n,8),2));return new Uint8Array(e)}function r(t){for(var e=[],o=0;o<t.length;o++){var d=t[o].data;"object"==typeof d&&(d=r(d)),"number"==typeof d&&(d=i(d.toString(2))),"string"==typeof d&&(d=n(d));var s=d.size||d.byteLength||d.length,u=Math.ceil(Math.ceil(Math.log(s)/Math.log(2))/8),c=s.toString(2),h=new Array(7*u+7+1-c.length).join("0")+c,l=new Array(u).join("0")+"1"+h;e.push(a(t[o].id)),e.push(i(l)),e.push(d)}return new Blob(e,{type:"video/webm"})}function o(t){var e=0;if(t.keyframe&&(e|=128),t.invisible&&(e|=8),t.lacing&&(e|=t.lacing<<1),t.discardable&&(e|=1),t.trackNum>127)throw"TrackNumber > 127 not supported";var a=[128|t.trackNum,t.timecode>>8,255&t.timecode,e].map(function(t){return String.fromCharCode(t)}).join("")+t.frame;return a}function d(t){for(var e=t.RIFF[0].WEBP[0],a=e.indexOf("*"),n=0,i=[];4>n;n++)i[n]=e.charCodeAt(a+3+n);var r,o,d;return d=i[1]<<8|i[0],r=16383&d,d=i[3]<<8|i[2],o=16383&d,{width:r,height:o,data:e,riff:t}}function s(t){for(var e=0,a={};e<t.length;){var n=t.substr(e,4),i=parseInt(t.substr(e+4,4).split("").map(function(t){var e=t.charCodeAt(0).toString(2);return new Array(8-e.length+1).join("0")+e}).join(""),2),r=t.substr(e+4+4,i);e+=8+i,a[n]=a[n]||[],a[n].push("RIFF"==n||"LIST"==n?s(r):r)}return a}function u(t){return[].slice.call(new Uint8Array(new Float64Array([t]).buffer),0).map(function(t){return String.fromCharCode(t)}).reverse().join("")}function c(t){this.frames=[],this.duration=t||1,this.quality=100}return c.prototype.add=function(t,e){if("canvas"in t&&(t=t.canvas),"toDataURL"in t&&(t=t.toDataURL("image/webp",this.quality)),!/^data:image\/webp;base64,/gi.test(t))throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp";this.frames.push({image:t,duration:e||this.duration})},c.prototype.compile=function(){return new t(this.frames.map(function(t){var e=d(s(atob(t.image.slice(23))));return e.duration=t.duration,e}))},{Video:c,toWebM:t}}();angular.module("webrtcTest").run(["$templateCache",function(t){t.put("app/main/main.html",'<div layout="vertical" layout-fill=""><header></header><md-content>test<audio id="audio" autoplay="" controls=""></audio><button class="btn btn-primary" ng-click="start()">Start recording</button> <button class="btn btn-primary" ng-click="stop()">Stop recording</button></md-content><div id="audios-container"></div><footer></footer></div>'),t.put("components/navbar/navbar.html",'<md-toolbar layout="row" layout-align="center center" ng-controller="NavbarCtrl"><md-button href="https://github.com/Swiip/generator-gulp-angular">Gulp Angular</md-button><section flex="" layout="row" layout-align="left center"><md-button href="#" class="md-raised">Home</md-button><md-button href="#" class="md-raised">About</md-button><md-button href="#" class="md-raised">Contact</md-button></section><md-button href="#">Current date: {{ date | date:\'yyyy-MM-dd\' }}</md-button></md-toolbar>')}]);